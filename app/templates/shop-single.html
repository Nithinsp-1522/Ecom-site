{% extends "base.html" %}
{% load static %}
{% block title %}{{ product.title }} | Product Details{% endblock %}

{% block content %}
<main class="py-5 bg-light">
   <div class="container">

      <!-- üß≠ Breadcrumb -->
      <nav aria-label="breadcrumb" class="mb-4">
         <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{% url 'index' %}">Home</a></li>
            <li class="breadcrumb-item">
               <a href="{% url 'category-products' product.category_id %}">
                  {{ product.category_name|default:"Category" }}
               </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">{{ product.title }}</li>
         </ol>
      </nav>

      <div class="row g-5 align-items-start">
         <!-- Left: Product Images -->
         <div class="col-lg-6 col-md-6">
            <div class="card border-0 shadow-sm">
               <div class="position-relative overflow-hidden rounded zoom-container">
                  <img id="mainImage" src="/media/{{ product.main_image }}" class="img-fluid rounded-3"
                     alt="{{ product.title }}">
               </div>

               <!-- Thumbnails -->
               <div class="d-flex flex-wrap justify-content-center gap-3 mt-3">
                  {% for img in images %}
                  <img src="/media/{{ img.image }}" onclick="changeImage(this.src, event)"
                     class="thumb-img border rounded {% if forloop.first %}active-thumb{% endif %}"
                     alt="Thumbnail {{ forloop.counter }}">
                  {% empty %}
                  <small class="text-muted">No other images available</small>
                  {% endfor %}
               </div>
            </div>
         </div>

         <!-- Right: Product Details -->
         <div class="col-lg-6 col-md-6">
            <h3 class="fw-bold mb-2">{{ product.title }}</h3>
            <p class="text-muted mb-2">{{ product.category_name }}{% if product.subcategory_name %} / {{
               product.subcategory_name }}{% endif %}</p>

            <div class="d-flex align-items-center mb-3">
               {% if product.sale_price %}
               <h4 class="text-dark me-3 mb-0">‚Çπ{{ product.sale_price }}</h4>
               <span class="text-decoration-line-through text-muted">‚Çπ{{ product.price }}</span>
               <span class="text-danger fw-semibold ms-2"></span>
               {% else %}
               <h4 class="text-dark mb-0">‚Çπ{{ product.price }}</h4>
               {% endif %}
            </div>

            <p class="small text-success fw-semibold">In Stock</p>

            <!-- Buttons -->
            <!-- Buttons -->
            <div class="d-flex flex-column gap-2 my-4">
               <form id="cartForm" method="POST" onsubmit="return false;">
                  {% csrf_token %}
                  <div class="d-flex align-items-center gap-2 mb-3">
                     <label class="fw-semibold">Quantity:</label>
                     <input type="number" id="quantity" name="quantity" value="1" min="1"
                        class="form-control w-auto text-center" style="width:80px;">
                  </div>
                  <button class="btn btn-outline-primary" onclick="addToCart({{ p.id }})">
   <i class="bi bi-cart-plus"></i> Add to Cart
</button>
                  <a href="{% url 'buy-now' product.id %}" class="btn btn-success px-4 mt-2">
                     <i class="bi bi-lightning-charge me-1"></i> Buy Now
                  </a>
               </form>
            </div>

         </div>
      </div>

      <!-- Tabs Section -->
      <div class="row mt-5">
         <div class="col-12">
            <ul class="nav nav-tabs" id="productTab" role="tablist">
               <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details"
                     type="button" role="tab">
                     Product Details
                  </button>
               </li>
               <li class="nav-item" role="presentation">
                  <button class="nav-link" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button"
                     role="tab">
                     Information
                  </button>
               </li>
               <li class="nav-item" role="presentation">
                  <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button"
                     role="tab">
                     Reviews
                  </button>
               </li>
               <li class="nav-item" role="presentation">
                  <button class="nav-link" id="seller-tab" data-bs-toggle="tab" data-bs-target="#seller" type="button"
                     role="tab">
                     Seller Info
                  </button>
               </li>
            </ul>

            <div class="tab-content border border-top-0 bg-white p-4 rounded-bottom shadow-sm">
               <!-- üßæ Product Details -->
               <div class="tab-pane fade show active" id="details" role="tabpanel">
                  <p>{{ product.description|linebreaksbr|default:"No description available." }}</p>
               </div>

               <!-- üìä Information Tab -->
               <div class="tab-pane fade" id="info" role="tabpanel">
                  <h5 class="mb-3">Details</h5>
                  {% if grouped_attrs %}
                  <div class="table-responsive">
                     <table class="table table-bordered align-middle">
                        <tbody>
                           {% for pair in grouped_attrs %}
                           <tr>
                              <th class="bg-light fw-semibold" style="width:20%;">{{ pair.0.field_name|capfirst }}</th>
                              <td style="width:30%;">{{ pair.0.field_value }}</td>

                              {% if pair|length > 1 %}
                              <th class="bg-light fw-semibold" style="width:20%;">{{ pair.1.field_name|capfirst }}</th>
                              <td style="width:30%;">{{ pair.1.field_value }}</td>
                              {% else %}
                              <th class="bg-light fw-semibold"></th>
                              <td></td>
                              {% endif %}
                           </tr>
                           {% endfor %}
                        </tbody>
                     </table>
                  </div>
                  {% else %}
                  <p class="text-muted">No additional product information available.</p>
                  {% endif %}
               </div>




               <!-- üí¨ Reviews -->
               <div class="tab-pane fade" id="reviews" role="tabpanel">
                  <p class="text-muted">Customer reviews section coming soon.</p>
               </div>

               <!-- Seller Info -->
               <div class="tab-pane fade" id="seller" role="tabpanel">
                  <p><strong>Seller Organization:</strong> {{ product.admin_org|default:"Verified Vendor" }}</p>
                  <p class="text-muted small mb-0">
                     All products are verified by <strong>{{ product.admin_org|default:"our platform" }}</strong> and
                     checked for quality
                     before approval.
                  </p>
               </div>



            </div>
         </div>
      </div>


      <!-- üõçÔ∏è Related Products -->
      <div class="row mt-5">
         <div class="col-12 mb-3">
            <h4 class="fw-bold">Related Products</h4>
            <hr>
         </div>

         <div class="row g-4 row-cols-xl-4 row-cols-lg-3 row-cols-md-3 row-cols-2">
            {% for r in related_products %}
            <div class="col">
               <div class="card card-product h-100">
                  <div class="card-body text-center">
                     <a href="{% url 'view-product' r.id %}">
                        <img src="/media/{{ r.main_image }}" class="img-fluid rounded mb-2"
                           style="height:200px;object-fit:cover;" alt="{{ r.title }}">
                     </a>
                     <h6 class="fw-semibold mt-2 mb-1 product-title">
                        <a href="{% url 'view-product' r.id %}" class="text-decoration-none text-dark">{{ r.title }}</a>
                     </h6>
                     <p class="text-muted small mb-1">{{ r.subcategory_name|default:r.category_name }}</p>
                     <div>
                        <span class="text-dark fw-semibold">‚Çπ{{ r.sale_price|default:r.price }}</span>
                        {% if r.sale_price %}
                        <span class="text-decoration-line-through text-muted small">‚Çπ{{ r.price }}</span>
                        {% endif %}
                     </div>
                  </div>
               </div>
            </div>
            {% empty %}
            <div class="text-center text-muted py-4">No related products found.</div>
            {% endfor %}
         </div>
      </div>

   </div>
</main>

<style>
   /* üñºÔ∏è Main zoom area */
   .zoom-container {
      position: relative;
      overflow: hidden;
      cursor: crosshair;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
   }

   .zoom-container img {
      width: 100%;
      height: auto;
      transition: transform 0.15s ease-out;
      transform-origin: center center;
   }

   /* üñ±Ô∏è Thumbnail styling */
   .thumb-img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
   }

   .thumb-img:hover,
   .thumb-img.active-thumb {
      border-color: #0d6efd;
      transform: scale(1.05);
   }

   /* üí≥ Product card hover (related section) */
   .card-product {
      border: 1px solid #f1f1f1;
      transition: all 0.2s ease;
   }

   .card-product:hover {
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
      transform: translateY(-3px);
   }

   .product-title {
      font-size: 1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
   }


   .table-bordered th {
      white-space: nowrap;
      width: 1%;
   }

   .table-bordered td {
      vertical-align: middle;
   }
</style>


<!-- üß† Script -->
<script>
   function changeImage(src, event) {
      const main = document.getElementById('mainImage');
      main.src = src;

      document.querySelectorAll('.thumb-img').forEach(img => img.classList.remove('active-thumb'));
      event.target.classList.add('active-thumb');
   }

   /* üß† Mouse-move Zoom Effect */
   document.addEventListener("DOMContentLoaded", () => {
      const container = document.querySelector(".zoom-container");
      const img = document.getElementById("mainImage");

      if (!container || !img) return;

      container.addEventListener("mousemove", (e) => {
         const rect = container.getBoundingClientRect();
         const x = e.clientX - rect.left;
         const y = e.clientY - rect.top;

         const xPercent = (x / rect.width) * 100;
         const yPercent = (y / rect.height) * 100;

         img.style.transformOrigin = `${xPercent}% ${yPercent}%`;
         img.style.transform = "scale(1.8)";
      });

      container.addEventListener("mouseleave", () => {
         img.style.transformOrigin = "center center";
         img.style.transform = "scale(1)";
      });
   });
</script>

 <script>
               function addToCart(pid) {
                  const qty = document.getElementById('quantity').value;
                  fetch(`/add-to-cart/${pid}/`, {
                     method: "POST",
                     headers: {
                        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
                     },
                     body: new URLSearchParams({ quantity: qty })
                  })
                     .then(res => res.json())
                     .then(data => {
                        if (data.status === "login_required") {
                           alert("Please log in to add items to your cart.");
                           window.location.href = "{% url 'userlogin' %}";
                        } else if (data.status === "success") {
                           alert("‚úÖ Product added to cart!");
                        }
                     })
                     .catch(err => console.error(err));
               }
            </script>

            <script>
function addToCart(pid){
   fetch(`/add-to-cart/${pid}/`, {
      method: "POST",
      headers: { "X-CSRFToken": "{{ csrf_token }}" },
      body: new URLSearchParams({ quantity: 1 })
   })
   .then(res => res.json())
   .then(data => {
      if (data.status === "login_required"){
         window.location.href = "{% url 'userlogin' %}";
      } else {
         refreshMiniCart();
         const offcanvas = new bootstrap.Offcanvas(document.getElementById('offcanvasRight'));
         offcanvas.show();
      }
   });
}
</script>


{% endblock %}