{% extends 'base.html' %}
{% load static %}
{% block title %}Search Results{% endblock %}
{% block content %}
<div class="container mt-5">
    <h4>Search Results for "{{ query }}"</h4>
    <hr>

    {% if products %}
    <div class="row">
        {% for p in products %}
        <div class="col-md-3 mb-4">
            <div class="card h-100 shadow-sm">
              <div class="position-absolute top-0 start-0 m-2">
  {% if p.stock <= 0 %}
    <span class="badge bg-secondary">Coming Soon</span>
  {% elif p.stock < 10 %}
    <span class="badge bg-warning text-dark">Only {{ p.stock }} Left</span>
  {% endif %}
</div>
                {% if p.image %}
                <img src="/media/{{ p.image }}" class="card-img-top" alt="{{ p.name }}">
                {% else %}
                <img src="{% static 'assets/images/no-image.png' %}" class="card-img-top" alt="No image">
                {% endif %}
               <div class="card-body">
    <h6 class="fw-semibold text-truncate" title="{{ p.name }}">{{ p.name }}</h6>
    <p class="text-muted mb-1">â‚¹{{ p.sale_price|default:p.price }}</p>

    <a href="{% url 'view-product' p.id %}" class="btn btn-sm btn-primary">View</a>

    {% if p.stock <= 0 %}
        <button class="btn btn-sm btn-secondary" disabled>Coming Soon</button>
    {% else %}
        <button class="btn btn-sm btn-success" onclick="addToCart({{ p.id }})">Add to Cart</button>
    {% endif %}
</div>

            </div>
        </div>
        {% endfor %}
    </div>

    <!-- âœ… Pagination -->
    {% if total_pages > 1 %}
    <nav aria-label="Search pagination">
        <ul class="pagination justify-content-center mt-4">
            {% if page > 1 %}
            <li class="page-item">
                <a class="page-link" href="?q={{ query }}&page={{ page|add:-1 }}">Previous</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">Previous</span></li>
            {% endif %}

            {% for i in page_numbers %}
            <li class="page-item {% if i == page %}active{% endif %}">
                <a class="page-link" href="?q={{ query }}&page={{ i }}">{{ i }}</a>
            </li>
            {% endfor %}

            {% if page < total_pages %} <li class="page-item">
                <a class="page-link" href="?q={{ query }}&page={{ page|add:1 }}">Next</a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">Next</span></li>
                {% endif %}
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <p class="text-muted">No products found for "{{ query }}".</p>
    {% endif %}
</div>

<script>
async function addToCart(productId) {
  const csrfToken = '{{ csrf_token }}';
  const res = await fetch(`/add-to-cart/${productId}/`, {
    method: "POST",
    headers: { "X-CSRFToken": csrfToken },
  });

  const data = await res.json();

  // âœ… Handle status responses
  if (data.status === "added") {
    Swal.fire({
      icon: "success",
      title: "Added to Cart ",
      text: data.message || "Product successfully added.",
      toast: true,
      position: "top-end",
      showConfirmButton: false,
      timer: 2500,
      timerProgressBar: true,
      background: "#f6fff5",
      iconColor: "#28a745"
    });

    updateCartCount(1);

  } else if (data.status === "updated") {
    Swal.fire({
      icon: "info",
      title: "Product Already In your Cart",
      text: data.message || "Product quantity increased in your cart.",
      toast: true,
      position: "top-end",
      showConfirmButton: false,
      timer: 2500,
      timerProgressBar: true,
      background: "#fff7e6",
      iconColor: "#ff9900"
    });

  } else if (data.status === "login_required") {
    Swal.fire({
      icon: "warning",
      title: "Please Login",
      text: "You must be logged in to add items to your cart.",
      confirmButtonText: "Login Now",
      confirmButtonColor: "#ff9900"
    }).then(result => {
      if (result.isConfirmed) {
        window.location.href = "{% url 'userlogin' %}";
      }
    });

  } else {
    Swal.fire({
      icon: "error",
      title: "Error",
      text: data.message || "Something went wrong. Try again later.",
      confirmButtonColor: "#d33"
    });
  }
}

// âœ… Optional â€” live cart badge update
function updateCartCount(change) {
  const badge = document.querySelector('.feather-shopping-bag + span.badge');
  if (data.status === "added") {
    Swal.fire({
      icon: "success",
      title: "Added to Cart ðŸ›’",
      text: data.message || "Product successfully added.",
      toast: true,
      position: "top-end",
      showConfirmButton: false,
      timer: 1500,
      timerProgressBar: true,
      background: "#f6fff5",
      iconColor: "#28a745"
    });

    updateCartCount(1);  // âœ… increment cart badge
}
}
</script>


{% endblock %}