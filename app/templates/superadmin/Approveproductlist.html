{% extends "superadmin/adminbase.html" %}
{% load static %}
{% block content %}
<main class="main-content-wrapper">
   <div class="container">
      <h2>Pending Products by {{ admin_user.username }}</h2>
      <a href="{% url 'approve-product' %}" class="btn btn-secondary mb-3">← Back to Admins</a>

      {% if products %}
      <div class="table-responsive">
         <table class="table table-centered table-hover">
            <thead class="bg-light">
               <tr>
                  <th>Image</th>
                  <th>Product Name</th>
                  <th>Category</th>
                  <th>Price</th>
                  <th>Status</th>
                  <th>Action</th>
               </tr>
            </thead>
            <tbody>
               {% for product in products %}
               <tr>
                  <td><img src="/media/{{ product.main_image }}" width="60" height="60" class="rounded"></td>
                  <td>{{ product.title }}</td>
                  <td>{{ product.category_name }}</td>
                  <td>₹{{ product.price }}</td>
                  <td>
                     {% if product.pending_approval %}
                     <span class="badge bg-warning text-dark">Pending</span>
                     {% elif product.approved %}
                     <span class="badge bg-success">Approved</span>
                     {% elif product.disapproved %}
                     <span class="badge bg-danger">Disapproved</span>
                     {% endif %}
                  </td>
                  <td>
                     {% if product.pending_approval %}
                     <a href="{% url 'approve-product-approve' product.id %}"
                        class="btn btn-success btn-sm me-2">Approve</a>

                     <!-- Disapprove trigger -->
                     <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal"
                        data-bs-target="#disapproveModal" data-product-id="{{ product.id }}"
                        data-product-title="{{ product.title|escape }}">
                        Disapprove
                     </button>
                     {% elif product.approved %}
                     <span class="text-success">✔ Approved</span>
                     {% elif product.disapproved %}
                     <span class="text-danger">✖ Disapproved</span>
                     {% endif %}
                  </td>
                  


               </tr>
               {% endfor %}
            </tbody>
         </table>
      </div>
      {% else %}
      <p>No products found for this admin.</p>
      {% endif %}
   </div>
</main>

<!-- Disapprove modal -->
<div class="modal fade" id="disapproveModal" tabindex="-1" aria-labelledby="disapproveModalLabel" aria-hidden="true">
   <div class="modal-dialog">
      <form method="post" id="disapproveForm">
         {% csrf_token %}
         <div class="modal-content">
            <div class="modal-header">
               <h5 class="modal-title" id="disapproveModalLabel">Disapprove Product</h5>
               <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
               <p id="disapproveProductTitle" class="mb-2"></p>
               <div class="mb-3">
                  <label for="disapprove_reason" class="form-label">Reason (optional)</label>
                  <textarea name="disapprove_reason" id="disapprove_reason" class="form-control" rows="4"
                     placeholder="Explain why the product is disapproved (optional)"></textarea>
               </div>
            </div>
            <div class="modal-footer">
               <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
               <button type="submit" class="btn btn-danger">Disapprove</button>
            </div>
         </div>
      </form>
   </div>
</div>

<script>
   document.addEventListener("DOMContentLoaded", function () {
      var disapproveModal = document.getElementById('disapproveModal');
      if (!disapproveModal) return;

      disapproveModal.addEventListener('show.bs.modal', function (event) {
         var button = event.relatedTarget;
         var productId = button.getAttribute('data-product-id');
         var productTitle = button.getAttribute('data-product-title');

         // set product title in modal
         var titleEl = document.getElementById('disapproveProductTitle');
         if (titleEl) {
            titleEl.textContent = productTitle ? "Product: " + productTitle : "";
         }

         // set form action to the disapprove URL
         var form = document.getElementById('disapproveForm');
         if (form) {
            // adjust to your named url; using path: approve-product-disapprove/<id>/
            form.action = "{% url 'approve-product-disapprove' 0 %}".replace('/0/', '/' + productId + '/');
         }
      });
   });
</script>

{% endblock %}